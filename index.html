<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real Trading Bot - Vrais Trades BSC</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            padding: 30px 0;
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            margin-bottom: 30px;
            border: 2px solid rgba(255,0,0,0.5);
            box-shadow: 0 0 30px rgba(255,0,0,0.3);
        }

        .header h1 {
            font-size: 2.5em;
            background: linear-gradient(90deg, #ff0000, #ff8c00);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .warning-banner {
            background: rgba(255,0,0,0.2);
            border: 2px solid #ff0000;
            border-radius: 15px;
            padding: 15px;
            margin: 20px 0;
            font-weight: bold;
            text-align: center;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: rgba(255,255,255,0.08);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }

        .card h2 {
            color: #00f5ff;
            margin-bottom: 15px;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            animation: blink 1.5s infinite;
        }

        .status-active { background: #00ff00; }
        .status-inactive { background: #ff0000; }
        .status-warning { background: #ffa500; }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #00f5ff;
            font-size: 0.9em;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 12px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            color: #fff;
            font-size: 1em;
        }

        .btn {
            padding: 12px 30px;
            background: linear-gradient(135deg, #00f5ff, #00ff88);
            border: none;
            border-radius: 8px;
            color: #000;
            font-weight: bold;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
            width: 100%;
            margin-top: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0,245,255,0.4);
        }

        .btn:disabled {
            background: #555;
            cursor: not-allowed;
            transform: none;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff0080, #ff8c00);
        }

        .btn-trade {
            background: linear-gradient(135deg, #00ff00, #00cc00);
            color: #000;
        }

        .price-display {
            font-size: 2em;
            font-weight: bold;
            color: #00ff88;
            text-align: center;
            padding: 20px;
            background: rgba(0,255,136,0.1);
            border-radius: 10px;
            margin: 10px 0;
        }

        .price-change {
            font-size: 0.5em;
            margin-left: 10px;
        }

        .price-up { color: #00ff00; }
        .price-down { color: #ff0000; }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .stat-item {
            background: rgba(255,255,255,0.05);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-label {
            font-size: 0.8em;
            color: #aaa;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.3em;
            font-weight: bold;
            color: #00f5ff;
        }

        .log-container {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
        }

        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .log-success { color: #00ff00; }
        .log-error { color: #ff0000; }
        .log-warning { color: #ffa500; }
        .log-info { color: #00f5ff; }

        .token-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }

        .token-box {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid rgba(255,255,255,0.1);
        }

        .token-box.selected {
            border-color: #00ff88;
            background: rgba(0,255,136,0.1);
        }

        .slippage-warning {
            background: rgba(255,165,0,0.2);
            border: 1px solid #ffa500;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 0.9em;
        }

        .trade-preview {
            background: rgba(0,245,255,0.1);
            border: 2px solid #00f5ff;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }

        .trade-preview-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .contract-address {
            font-size: 0.75em;
            color: #888;
            word-break: break-all;
            margin-top: 5px;
        }

        .balance-display {
            background: rgba(255,255,255,0.05);
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üî• REAL TRADING BOT</h1>
            <div style="color: #ff0000; font-weight: bold; font-size: 1.2em;">‚ö†Ô∏è VRAIS TRADES SUR LA BLOCKCHAIN BSC ‚ö†Ô∏è</div>
        </div>

        <div class="warning-banner">
            ‚ö†Ô∏è ATTENTION: Ce bot effectue de VRAIS trades avec de la VRAIE crypto monnaie!<br>
            Vous pouvez PERDRE de l'argent r√©el. Utilisez √† vos propres risques!
        </div>

        <div class="grid">
            <!-- Connexion Wallet -->
            <div class="card">
                <h2><span class="status-indicator status-inactive" id="walletStatus"></span> Connexion Wallet</h2>
                <div class="input-group">
                    <label>Type de Connexion</label>
                    <select id="connectionType">
                        <option value="metamask">MetaMask</option>
                        <option value="privatekey">Cl√© Priv√©e</option>
                    </select>
                </div>
                <div class="input-group" id="privateKeyInput" style="display: none;">
                    <label>‚ö†Ô∏è Cl√© Priv√©e</label>
                    <input type="password" id="privateKey" placeholder="0x...">
                </div>
                <button class="btn" id="connectBtn">üîó Connecter</button>
                <div id="walletInfo" style="margin-top: 15px; display: none;">
                    <div class="balance-display">
                        <strong>Adresse:</strong> <span id="walletAddress"></span><br>
                        <strong>BNB:</strong> <span id="bnbBalance">0</span> BNB<br>
                        <strong>USDT:</strong> <span id="usdtBalance">0</span> USDT<br>
                        <strong>BUSD:</strong> <span id="busdBalance">0</span> BUSD
                    </div>
                </div>
            </div>

            <!-- Prix en temps r√©el -->
            <div class="card">
                <h2><span class="status-indicator status-active"></span> Prix Temps R√©el</h2>
                <div class="input-group">
                    <label>Paire</label>
                    <select id="tradingPair">
                        <option value="BNBUSDT">BNB/USDT</option>
                        <option value="BTCUSDT">BTC/USDT</option>
                        <option value="ETHUSDT">ETH/USDT</option>
                    </select>
                </div>
                <div class="price-display">
                    <span id="currentPrice">--</span>
                    <span class="price-change" id="priceChange">--</span>
                </div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-label">24h High</div>
                        <div class="stat-value" id="high24h">--</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">24h Low</div>
                        <div class="stat-value" id="low24h">--</div>
                    </div>
                </div>
            </div>

            <!-- Configuration de Trade R√âEL -->
            <div class="card" style="grid-column: 1 / -1;">
                <h2>üí∞ Configuration Trade R√âEL</h2>
                
                <div class="token-selector">
                    <div class="token-box" id="tokenFromBox">
                        <div style="font-weight: bold; margin-bottom: 10px;">De (FROM)</div>
                        <select id="tokenFrom" class="input-group">
                            <option value="0xbb4CdB9CBd36B01bD1cBaEBF2De08d9173bc095c">WBNB</option>
                            <option value="0x55d398326f99059fF775485246999027B3197955">USDT</option>
                            <option value="0xe9e7CEA3DedcA5984780Bafc599bD69ADd087D56">BUSD</option>
                        </select>
                        <input type="number" id="amountFrom" placeholder="Montant" step="0.01" min="0.01" style="margin-top: 10px; width: 100%; padding: 8px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 5px; color: #fff;">
                        <div class="contract-address" id="fromAddress">0xbb4C...095c</div>
                    </div>
                    
                    <div class="token-box" id="tokenToBox">
                        <div style="font-weight: bold; margin-bottom: 10px;">Vers (TO)</div>
                        <select id="tokenTo" class="input-group">
                            <option value="0x55d398326f99059fF775485246999027B3197955">USDT</option>
                            <option value="0xbb4CdB9CBd36B01bD1cBaEBF2De08d9173bc095c">WBNB</option>
                            <option value="0xe9e7CEA3DedcA5984780Bafc599bD69ADd087D56">BUSD</option>
                        </select>
                        <div style="margin-top: 10px; padding: 8px; background: rgba(0,255,136,0.1); border-radius: 5px; min-height: 40px; display: flex; align-items: center; justify-content: center; color: #00ff88; font-weight: bold;" id="amountToEstimate">
                            ~ 0.00
                        </div>
                        <div class="contract-address" id="toAddress">0x55d3...7955</div>
                    </div>
                </div>

                <div class="input-group">
                    <label>Slippage Tol√©rance (%)</label>
                    <input type="number" id="slippage" value="1" min="0.1" max="50" step="0.1">
                </div>

                <div class="slippage-warning">
                    ‚ö†Ô∏è Slippage = Diff√©rence de prix acceptable. 1% recommand√© pour tokens stables, 2-5% pour tokens volatils
                </div>

                <div class="trade-preview" id="tradePreview" style="display: none;">
                    <h3 style="margin-bottom: 10px; color: #00f5ff;">üìã Aper√ßu du Trade</h3>
                    <div class="trade-preview-item">
                        <span>Vous envoyez:</span>
                        <strong id="previewFrom">--</strong>
                    </div>
                    <div class="trade-preview-item">
                        <span>Vous recevez (estim√©):</span>
                        <strong id="previewTo">--</strong>
                    </div>
                    <div class="trade-preview-item">
                        <span>Prix unitaire:</span>
                        <strong id="previewRate">--</strong>
                    </div>
                    <div class="trade-preview-item">
                        <span>Slippage max:</span>
                        <strong id="previewSlippage">--</strong>
                    </div>
                    <div class="trade-preview-item">
                        <span>Frais r√©seau (Gas):</span>
                        <strong id="previewGas">~ 0.002 BNB</strong>
                    </div>
                    <div class="trade-preview-item" style="border: none; margin-top: 10px; font-size: 1.1em;">
                        <span>Minimum re√ßu:</span>
                        <strong style="color: #00ff88;" id="previewMin">--</strong>
                    </div>
                </div>

                <button class="btn btn-trade" id="calculateBtn">üîç Calculer le Trade</button>
                <button class="btn btn-danger" id="executeTradeBtn" style="display: none;">‚ö° EX√âCUTER LE TRADE R√âEL</button>
            </div>

            <!-- Historique des Trades -->
            <div class="card">
                <h2>üìä Historique Trades</h2>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-label">Trades Effectu√©s</div>
                        <div class="stat-value" id="totalTrades">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Volume Total</div>
                        <div class="stat-value" id="totalVolume">$0</div>
                    </div>
                </div>
                <div id="tradeHistory" style="margin-top: 15px; max-height: 300px; overflow-y: auto;">
                    <div style="text-align: center; color: #aaa; padding: 20px;">
                        Aucun trade effectu√©
                    </div>
                </div>
            </div>

            <!-- Performances -->
            <div class="card">
                <h2>üìà Performances</h2>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-label">Profit/Perte</div>
                        <div class="stat-value" style="color: #00ff88;" id="totalPnL">$0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">ROI</div>
                        <div class="stat-value" id="roi">0%</div>
                    </div>
                </div>
            </div>

            <!-- Logs -->
            <div class="card" style="grid-column: 1 / -1;">
                <h2>üìú Logs Syst√®me</h2>
                <div class="log-container" id="logContainer">
                    <div class="log-entry log-info">[INFO] Syst√®me initialis√©</div>
                    <div class="log-entry log-warning">[WARNING] Ce bot effectue de VRAIS trades!</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Contrats BSC
        const PANCAKE_ROUTER = '0x10ED43C718714eb63d5aA57B78B54704E256024E';
        const WBNB = '0xbb4CdB9CBd36B01bD1cBaEBF2De08d9173bc095c';
        const USDT = '0x55d398326f99059fF775485246999027B3197955';
        const BUSD = '0xe9e7CEA3DedcA5984780Bafc599bD69ADd087D56';

        // ABI PancakeSwap Router
        const ROUTER_ABI = [
            {"inputs":[{"internalType":"uint256","name":"amountIn","type":"uint256"},{"internalType":"address[]","name":"path","type":"address[]"}],"name":"getAmountsOut","outputs":[{"internalType":"uint256[]","name":"amounts","type":"uint256[]"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"uint256","name":"amountIn","type":"uint256"},{"internalType":"uint256","name":"amountOutMin","type":"uint256"},{"internalType":"address[]","name":"path","type":"address[]"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"deadline","type":"uint256"}],"name":"swapExactTokensForTokens","outputs":[{"internalType":"uint256[]","name":"amounts","type":"uint256[]"}],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[{"internalType":"uint256","name":"amountOutMin","type":"uint256"},{"internalType":"address[]","name":"path","type":"address[]"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"deadline","type":"uint256"}],"name":"swapExactETHForTokens","outputs":[{"internalType":"uint256[]","name":"amounts","type":"uint256[]"}],"stateMutability":"payable","type":"function"},
            {"inputs":[{"internalType":"uint256","name":"amountIn","type":"uint256"},{"internalType":"uint256","name":"amountOutMin","type":"uint256"},{"internalType":"address[]","name":"path","type":"address[]"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"deadline","type":"uint256"}],"name":"swapExactTokensForETH","outputs":[{"internalType":"uint256[]","name":"amounts","type":"uint256[]"}],"stateMutability":"nonpayable","type":"function"}
        ];

        // ABI ERC20
        const ERC20_ABI = [
            {"constant":true,"inputs":[{"name":"_owner","type":"address"}],"name":"balanceOf","outputs":[{"name":"balance","type":"uint256"}],"type":"function"},
            {"constant":false,"inputs":[{"name":"_spender","type":"address"},{"name":"_value","type":"uint256"}],"name":"approve","outputs":[{"name":"","type":"bool"}],"type":"function"},
            {"constant":true,"inputs":[{"name":"_owner","type":"address"},{"name":"_spender","type":"address"}],"name":"allowance","outputs":[{"name":"","type":"uint256"}],"type":"function"},
            {"constant":true,"inputs":[],"name":"decimals","outputs":[{"name":"","type":"uint8"}],"type":"function"}
        ];

        let web3;
        let userAccount;
        let ws;
        let routerContract;
        let currentPrice = 0;
        let trades = [];

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            startPriceWebSocket();
            addLog('INFO', 'Bot de trading R√âEL initialis√©');
            addLog('WARNING', 'ATTENTION: Vos trades seront ex√©cut√©s sur la vraie blockchain BSC!');
        });

        function setupEventListeners() {
            document.getElementById('connectionType').addEventListener('change', function() {
                document.getElementById('privateKeyInput').style.display = 
                    this.value === 'privatekey' ? 'block' : 'none';
            });

            document.getElementById('connectBtn').addEventListener('click', connectWallet);
            document.getElementById('calculateBtn').addEventListener('click', calculateTrade);
            document.getElementById('executeTradeBtn').addEventListener('click', executeTrade);
            
            // Mise √† jour auto des adresses affich√©es
            document.getElementById('tokenFrom').addEventListener('change', updateTokenAddresses);
            document.getElementById('tokenTo').addEventListener('change', updateTokenAddresses);
            document.getElementById('amountFrom').addEventListener('input', debounce(calculateTrade, 1000));
        }

        async function connectWallet() {
            const type = document.getElementById('connectionType').value;
            
            try {
                if (type === 'metamask') {
                    if (typeof window.ethereum === 'undefined') {
                        alert('MetaMask non install√©!\nInstallez depuis: https://metamask.io');
                        return;
                    }
                    
                    addLog('INFO', 'Connexion √† MetaMask...');
                    web3 = new Web3(window.ethereum);
                    const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
                    userAccount = accounts[0];
                    
                    const chainId = await web3.eth.getChainId();
                    if (chainId !== 56n) {
                        addLog('WARNING', 'Changement vers BSC Mainnet...');
                        await ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0x38' }],
                        });
                    }
                } else {
                    const privateKey = document.getElementById('privateKey').value.trim();
                    if (!privateKey || privateKey.length < 64) {
                        addLog('ERROR', 'Cl√© priv√©e invalide');
                        return;
                    }
                    
                    web3 = new Web3('https://bsc-dataseed.binance.org/');
                    const account = web3.eth.accounts.privateKeyToAccount(privateKey);
                    userAccount = account.address;
                    web3.eth.accounts.wallet.add(account);
                }
                
                // Initialiser le contrat Router
                routerContract = new web3.eth.Contract(ROUTER_ABI, PANCAKE_ROUTER);
                
                // R√©cup√©rer les balances
                await updateBalances();
                
                document.getElementById('walletAddress').textContent = 
                    userAccount.substring(0, 6) + '...' + userAccount.substring(38);
                document.getElementById('walletInfo').style.display = 'block';
                document.getElementById('walletStatus').className = 'status-indicator status-active';
                
                addLog('SUCCESS', `Wallet connect√©: ${userAccount.substring(0, 10)}...`);
                addLog('SUCCESS', 'Contrat PancakeSwap Router initialis√©');
                
            } catch (error) {
                addLog('ERROR', `Erreur: ${error.message}`);
                console.error(error);
            }
        }

        async function updateBalances() {
            try {
                // Balance BNB
                const bnbBal = await web3.eth.getBalance(userAccount);
                document.getElementById('bnbBalance').textContent = 
                    parseFloat(web3.utils.fromWei(bnbBal, 'ether')).toFixed(4);
                
                // Balance USDT
                const usdtContract = new web3.eth.Contract(ERC20_ABI, USDT);
                const usdtBal = await usdtContract.methods.balanceOf(userAccount).call();
                document.getElementById('usdtBalance').textContent = 
                    parseFloat(web3.utils.fromWei(usdtBal, 'ether')).toFixed(2);
                
                // Balance BUSD
                const busdContract = new web3.eth.Contract(ERC20_ABI, BUSD);
                const busdBal = await busdContract.methods.balanceOf(userAccount).call();
                document.getElementById('busdBalance').textContent = 
                    parseFloat(web3.utils.fromWei(busdBal, 'ether')).toFixed(2);
                
            } catch (error) {
                addLog('ERROR', `Erreur r√©cup√©ration balances: ${error.message}`);
            }
        }

        function startPriceWebSocket() {
            const pair = document.getElementById('tradingPair').value.toLowerCase();
            
            ws = new WebSocket(`wss://stream.binance.com:9443/ws/${pair}@ticker`);
            
            ws.onopen = () => addLog('SUCCESS', 'Prix en temps r√©el connect√©');
            
            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                currentPrice = parseFloat(data.c);
                const change24h = parseFloat(data.P);
                
                document.getElementById('currentPrice').textContent = '$' + currentPrice.toFixed(2);
                const changeElem = document.getElementById('priceChange');
                changeElem.textContent = (change24h >= 0 ? '+' : '') + change24h.toFixed(2) + '%';
                changeElem.className = 'price-change ' + (change24h >= 0 ? 'price-up' : 'price-down');
                
                document.getElementById('high24h').textContent = '$' + parseFloat(data.h).toFixed(2);
                document.getElementById('low24h').textContent = '$' + parseFloat(data.l).toFixed(2);
            };
        }

        function updateTokenAddresses() {
            const fromAddr = document.getElementById('tokenFrom').value;
            const toAddr = document.getElementById('tokenTo').value;
            
            document.getElementById('fromAddress').textContent = 
                fromAddr.substring(0, 6) + '...' + fromAddr.substring(38);
            document.getElementById('toAddress').textContent = 
                toAddr.substring(0, 6) + '...' + toAddr.substring(38);
        }

        async function calculateTrade() {
            if (!web3 || !userAccount) {
                addLog('ERROR', 'Connectez votre wallet d\'abord!');
                return;
            }

            const amountIn = document.getElementById('amountFrom').value;
            if (!amountIn || parseFloat(amountIn) <= 0) {
                return;
            }

            const tokenFrom = document.getElementById('tokenFrom').value;
            const tokenTo = document.getElementById('tokenTo').value;
            const slippage = parseFloat(document.getElementById('slippage').value);

            try {
                addLog('INFO', 'Calcul du trade via PancakeSwap...');

                const amountInWei = web3.utils.toWei(amountIn, 'ether');
                const path = [tokenFrom, tokenTo];

                // Appel R√âEL √† PancakeSwap pour obtenir le prix
                const amounts = await routerContract.methods.getAmountsOut(amountInWei, path).call();
                const amountOut = amounts[1];
                const amountOutFormatted = parseFloat(web3.utils.fromWei(amountOut, 'ether')).toFixed(6);

                // Calcul du minimum avec slippage
                const minAmount = parseFloat(amountOutFormatted) * (1 - slippage / 100);

                // Mise √† jour de l'interface
                document.getElementById('amountToEstimate').textContent = `~ ${amountOutFormatted}`;
                
                const tokenFromName = document.getElementById('tokenFrom').options[document.getElementById('tokenFrom').selectedIndex].text;
                const tokenToName = document.getElementById('tokenTo').options[document.getElementById('tokenTo').selectedIndex].text;

                document.getElementById('previewFrom').textContent = `${amountIn} ${tokenFromName}`;
                document.getElementById('previewTo').textContent = `${amountOutFormatted} ${tokenToName}`;
                document.getElementById('previewRate').textContent = `1 ${tokenFromName} = ${(parseFloat(amountOutFormatted) / parseFloat(amountIn)).toFixed(4)} ${tokenToName}`;
                document.getElementById('previewSlippage').textContent = slippage + '%';
                document.getElementById('previewMin').textContent = `${minAmount.toFixed(6)} ${tokenToName}`;

                document.getElementById('tradePreview').style.display = 'block';
                document.getElementById('executeTradeBtn').style.display = 'block';

                addLog('SUCCESS', `Prix calcul√©: ${amountOutFormatted} ${tokenToName}`);

            } catch (error) {
                addLog('ERROR', `Erreur calcul: ${error.message}`);
                console.error(error);
            }
        }

        async function executeTrade() {
            if (!confirm('‚ö†Ô∏è ATTENTION!\n\nVous allez ex√©cuter un VRAI trade sur la blockchain BSC.\nCe trade co√ªtera des frais de gas et est IRR√âVERSIBLE.\n\n√ätes-vous absolument s√ªr?')) {
                return;
            }

            const amountIn = document.getElementById('amountFrom').value;
            const tokenFrom = document.getElementById('tokenFrom').value;
            const tokenTo = document.getElementById('tokenTo').value;
            const slippage = parseFloat(document.getElementById('slippage').value);

            try {
                addLog('WARNING', '‚ö° Ex√©cution du trade R√âEL...');

                const amountInWei = web3.utils.toWei(amountIn, 'ether');
                const path = [tokenFrom, tokenTo];

                // Obtenir le montant estim√©
                const amounts = await routerContract.methods.getAmountsOut(amountInWei, path).call();
                const amountOut = amounts[1];
                
                // Calculer le minimum avec slippage
                const amountOutMin = (BigInt(amountOut) * BigInt(Math.floor((100 - slippage) * 100)) / BigInt(10000)).toString();

                // V√©rifier et approuver le token si n√©cessaire
                if (tokenFrom !== WBNB) {
                    addLog('INFO', 'V√©rification de l\'approbation du token...');
                    const tokenContract = new web3.eth.Contract(ERC20_ABI, tokenFrom);
                    const allowance = await tokenContract.methods.allowance(userAccount, PANCAKE_ROUTER).call();
                    
                    if (BigInt(allowance) < BigInt(amountInWei)) {
                        addLog('INFO', 'Approbation du token en cours...');
                        const approveTx = await tokenContract.methods.approve(
                            PANCAKE_ROUTER,
                            '0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff'
                        ).send({ from: userAccount });
                        addLog('SUCCESS', `Token approuv√©! TX: ${approveTx.transactionHash}`);
                    }
                }

                // Ex√©cuter le swap
                const deadline = Math.floor(Date.now() / 1000) + 60 * 20; // 20 minutes
                
                addLog('WARNING', 'üî• Envoi de la transaction de swap...');
                
                let tx;
                if (tokenFrom === WBNB) {
                    // Swap BNB vers Token
                    tx = await routerContract.methods.swapExactETHForTokens(
                        amountOutMin,
                        path,
                        userAccount,
                        deadline
                    ).send({
                        from: userAccount,
                        value: amountInWei
                    });
                } else if (tokenTo === WBNB) {
                    // Swap Token vers BNB
                    tx = await routerContract.methods.swapExactTokensForETH(
                        amountInWei,
                        amountOutMin,
                        path,
                        userAccount,
                        deadline
                    ).send({ from: userAccount });
                } else {
                    // Swap Token vers Token
                    tx = await routerContract.methods.swapExactTokensForTokens(
                        amountInWei,
                        amountOutMin,
                        path,
                        userAccount,
                        deadline
                    ).send({ from: userAccount });
                }

                addLog('SUCCESS', `‚úÖ TRADE EX√âCUT√â AVEC SUCC√àS!`);
                addLog('SUCCESS', `TX Hash: ${tx.transactionHash}`);
                addLog('SUCCESS', `Voir sur BSCScan: https://bscscan.com/tx/${tx.transactionHash}`);

                // Mettre √† jour les balances
                await updateBalances();

                // Ajouter √† l'historique
                addTradeToHistory(amountIn, tokenFrom, tokenTo, tx.transactionHash);

                // R√©initialiser le formulaire
                document.getElementById('tradePreview').style.display = 'none';
                document.getElementById('executeTradeBtn').style.display = 'none';

            } catch (error) {
                addLog('ERROR', `‚ùå Erreur lors du trade: ${error.message}`);
                console.error(error);
                alert('Erreur lors du trade!\n' + error.message);
            }
        }

        function addTradeToHistory(amount, from, to, txHash) {
            const container = document.getElementById('tradeHistory');
            
            if (container.children[0]?.textContent?.includes('Aucun trade')) {
                container.innerHTML = '';
            }

            const trade = document.createElement('div');
            trade.style.cssText = 'background: rgba(0,255,136,0.1); padding: 10px; border-radius: 8px; margin-bottom: 10px; border-left: 3px solid #00ff88;';
            trade.innerHTML = `
                <strong>${amount} ${from.substring(0,8)}... ‚Üí ${to.substring(0,8)}...</strong><br>
                <small style="color: #aaa;">${new Date().toLocaleString()}</small><br>
                <a href="https://bscscan.com/tx/${txHash}" target="_blank" style="color: #00f5ff; text-decoration: none;">
                    Voir TX: ${txHash.substring(0,10)}...
                </a>
            `;

            container.insertBefore(trade, container.firstChild);

            // Mise √† jour des stats
            trades.push({amount, from, to, txHash, time: new Date()});
            document.getElementById('totalTrades').textContent = trades.length;
        }

        function addLog(type, message) {
            const container = document.getElementById('logContainer');
            const log = document.createElement('div');
            log.className = `log-entry log-${type.toLowerCase()}`;
            log.textContent = `[${type}] ${new Date().toLocaleTimeString()} - ${message}`;
            
            container.insertBefore(log, container.firstChild);
            
            while (container.children.length > 100) {
                container.removeChild(container.lastChild);
            }
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
    </script>
</body>
</html>
